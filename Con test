import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

public class ReferenceGenerator {
    
    public String generateReferenceNo(String transactionName, Connection connection) throws SQLException {
        String sequenceName;
        String refCode;
        String refNo = null;
        String nextValue;
        
        // Determine reference code based on transaction name
        if ("FEE".equals(transactionName)) {
            refCode = "CU";
        } else if ("SARALMTOPUP".equals(transactionName)) {
            refCode = "CV";
        } else {
            refCode = transactionName.trim();
        }
        
        // Build sequence name
        sequenceName = "R" + refCode + "REF.nextval";
        
        // Execute sequence query
        String sql = "SELECT " + sequenceName + " FROM dual";
        try (PreparedStatement stmt = connection.prepareStatement(sql);
             ResultSet rs = stmt.executeQuery()) {
            
            if (rs.next()) {
                nextValue = rs.getString(1);
                
                // Format the reference number based on refCode
                if (refCode.matches("CK|IU|CR")) {
                    refNo = refCode + (char) Integer.parseInt(nextValue.substring(0, 2)) 
                            + nextValue.substring(2);
                } else if (refCode.matches("CX|CN|CI|CT")) {
                    long numericValue = Long.parseLong(nextValue);
                    long floorValue = numericValue / 10;
                    String alphaNumRef = alphaNumRefNo(floorValue); // Need to implement FN_ALPHA_NUM_REF_NO
                    refNo = refCode + String.format("%07d", Long.parseLong(alphaNumRef)) 
                            + nextValue.substring(nextValue.length() - 1);
                } else {
                    refNo = refCode + String.format("%08d", Long.parseLong(nextValue));
                }
            }
        }
        
        return refNo;
    }
    
    // Placeholder for FN_ALPHA_NUM_REF_NO function - needs proper implementation
    private String alphaNumRefNo(long value) {
        // TODO: Implement the actual logic for FN_ALPHA_NUM_REF_NO
        // This is a placeholder - the original PL/SQL function isn't shown
        return String.valueOf(value);
    }
}
