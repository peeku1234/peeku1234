package com.sbi.yb.cinb.controller;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.sbi.yb.cinb.constant.FileUploadConstants;
import com.sbi.yb.cinb.constant.FileUploadStatusCodeConstants;
import com.sbi.yb.cinb.exception.UploadBeneficiaryFileException;
import com.sbi.yb.cinb.model.CustomMultipartFile;
import com.sbi.yb.cinb.model.UploadFileRequest;
import com.sbi.yb.cinb.model.UploadFileResponse;
import com.sbi.yb.cinb.service.UploadFileService;
import com.sbi.yb.cinb.util.FileUploadUtil;
import com.sbi.yb.exception.CommonException;
import com.sbi.yb.exception.MicroServiceException;
import com.sbi.yb.model.SBIApplicationResponse;
import com.sbi.yb.utils.LoggerUtil;
import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpServletResponse;
import org.slf4j.Logger;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import java.io.IOException;
import java.math.BigInteger;
import java.net.URLConnection;
import java.util.Base64;
import java.util.Objects;
import java.util.Optional;

import static com.sbi.yb.cinb.constant.FileUploadStatusCodeConstants.FILE_UPLOAD_SUCCESS;


/*
 * @author V1017263
 * @Description : This class {@code UploadFileController} includes method for Uploading files
 */

@RestController
public class UploadFileController {

  private static final Logger logger = LoggerUtil.getLogger(UploadFileController.class);

  private UploadFileService uploadFileServiceImpl;

  public UploadFileController(UploadFileService uploadFileServiceImpl) {
    this.uploadFileServiceImpl = uploadFileServiceImpl;

  }

  @Value("${upload-file.excluded.extensions}")
  String excludedFiletypes;

  /**
   * This method is to upload beneficiary files
   *
   * @param httpServletRequest
   * @param httpServletResponse
   * @return {@code ResponseEntity<SBIApplicationResponse>}
   */
  @PostMapping(value = "/beneficiary")
  public ResponseEntity<SBIApplicationResponse> uploadBeneficiaryFile(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse) throws CommonException, JsonProcessingException {
    logger.info("uploadBeneficiaryFile - starts");

    Optional<String> plainPayload = FileUploadUtil.safeGetParameter(httpServletRequest, "plainPayload");

    UploadFileRequest uploadFileRequest = null;
    SBIApplicationResponse sbiApplicationResponse = null;
    try {
            /*
            Deserializing JSON content
             */
      uploadFileRequest = (UploadFileRequest) FileUploadUtil.toObject(plainPayload.orElseThrow(() ->
              new MicroServiceException(FileUploadStatusCodeConstants.INVALID_REQUEST)), UploadFileRequest.class);

    } catch (JsonProcessingException jsonProcessingException) {
      logger.info("Request could not be parsed as JSON.");
      MicroServiceException.throwException(FileUploadStatusCodeConstants.INVALID_REQUEST, jsonProcessingException);
    }

    plainPayload.ifPresent(payload -> logger.info("plainPayload: {}", payload));
    logger.info("UploadBeneficiaryFileRequest : {}", uploadFileRequest);

    if (Optional.ofNullable(uploadFileRequest).isPresent()) {
        /*
        Validating file type
         */
      if (!FileUploadConstants.ACC_BENE_FILE_TYPES.stream().anyMatch(uploadFileRequest.getFileType()::equalsIgnoreCase))
        UploadBeneficiaryFileException.throwException(FileUploadStatusCodeConstants.INVALID_FILE_TYPE);

      logger.info("File type is valid");

                /*
                Validating file name & format
                 */
      if (!FileUploadUtil.validateFileFormat(excludedFiletypes, uploadFileRequest.getFileName()))
        UploadBeneficiaryFileException.throwException(FileUploadStatusCodeConstants.INVALID_FILE_FORMAT);

      logger.info("File format validation successful");

            /*
            Building custom multipart file object
             */
      MultipartFile file = new CustomMultipartFile(Base64.getDecoder().decode(uploadFileRequest.getFileContent())
              , uploadFileRequest.getFileName(), URLConnection.guessContentTypeFromName(uploadFileRequest.getFileName()));

      logger.info("MultipartFile : {}", file);


      if (Objects.nonNull(file) && !file.isEmpty() && Objects.nonNull(uploadFileRequest.getUserName())
              && Objects.nonNull(uploadFileRequest.getCorporateAlias()))

        sbiApplicationResponse = FileUploadUtil.buildSuccessResponse(
                /*
                 * Creates a new file & writes the content
                 * Transfers the file to specified path & inserts uploaded file details in DB
                 */
                uploadFileServiceImpl.uploadConfigurationFile(file, uploadFileRequest.getFileType().toUpperCase(),
                        uploadFileRequest.getUserName(), uploadFileRequest.getCorporateAlias())
                , FILE_UPLOAD_SUCCESS);
    }
    logger.info("uploadBeneficiaryFile() - response : {}",sbiApplicationResponse);

    return new ResponseEntity<>(sbiApplicationResponse, HttpStatus.OK);
  }
}



i want test case like this
package com.sbi.yb.cinb.controller;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.sbi.yb.cinb.constants.UtilsConstant;
import com.sbi.yb.cinb.model.GetConfigurationRequest;
import com.sbi.yb.cinb.model.GetConfigurationResponse;
import com.sbi.yb.cinb.service.impl.FileConfigurationServiceImpl;
import com.sbi.yb.exception.MicroServiceException;
import jakarta.servlet.http.*;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.Mockito;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.web.servlet.MockMvc;
import java.util.*;
import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;

@SpringBootTest
@AutoConfigureMockMvc
class FileConfigurationControllerTest {
    @InjectMocks
    private FileConfigurationController fileDownloadController;
    @Mock
    private MockMvc mockMvc;
    @Mock
    private FileConfigurationServiceImpl fileDownloadService;
    @Mock
    private HttpServletRequest httpServletRequest;
    @Mock
    private HttpServletResponse httpServletResponse;
    private final ObjectMapper objectMapper = new ObjectMapper();

    @Test
    void downloadSampleFile() throws Exception {
        GetConfigurationRequest getConfigurationRequest = new GetConfigurationRequest();
        GetConfigurationResponse getConfigurationResponse = new GetConfigurationResponse();
        getConfigurationRequest.setFileType("IMPS_TXN");
        Map<String, Object> mockFileContent = new HashMap<>();
        mockFileContent.put(UtilsConstant.SUCCESS, UtilsConstant.SUCCESS);
        Mockito.when(httpServletRequest.getAttribute("plainPayload")).thenReturn(objectMapper.writeValueAsString(getConfigurationRequest));
        Mockito.when(fileDownloadService.getConfiguration(any(GetConfigurationRequest.class))).thenReturn(getConfigurationResponse);
        fileDownloadController.getConfiguration(httpServletRequest, httpServletResponse);
        Mockito.verify(httpServletRequest).getAttribute("plainPayload");
        assertEquals("SUCCESS", UtilsConstant.SUCCESS);

    }

    @Test
    void downloadSampleFile_() throws Exception {
        GetConfigurationRequest getConfigurationRequest = new GetConfigurationRequest();
        getConfigurationRequest.setFileType(null);
        Map<String, Object> mockFileContent = new HashMap<>();
        mockFileContent.put(UtilsConstant.SUCCESS, UtilsConstant.SUCCESS);
        Mockito.when(httpServletRequest.getAttribute("plainPayload")).thenReturn(objectMapper.writeValueAsString(getConfigurationRequest));
        assertThrows(MicroServiceException.class, () -> {
            fileDownloadController.getConfiguration(httpServletRequest, httpServletResponse);
        });
        Mockito.verify(httpServletRequest).getAttribute("plainPayload");
        assertEquals("SUCCESS", UtilsConstant.SUCCESS);

    }

    @Test
    void exception() {
        Optional<String> string = Optional.empty();
        Mockito.when(httpServletRequest.getAttribute("pl")).thenReturn(string);
        assertThrows(MicroServiceException.class, () -> {
            fileDownloadController.getConfiguration(httpServletRequest, httpServletResponse);
        });

    }
}



